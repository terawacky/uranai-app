import streamlit as st
from datetime import datetime, time, date
import pandas as pd

# ãƒšãƒ¼ã‚¸è¨­å®š
st.set_page_config(page_title="æœ¬æ ¼å››æŸ±æ¨å‘½ãƒ»çµ±åˆé‘‘å®šã‚·ã‚¹ãƒ†ãƒ ", layout="centered")

# --- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ ---
jukkan_info = {
    "ç”²": {"ã‚¿ã‚¤ãƒ—": "ğŸŒ² å¤§æ¨¹", "æ„å‘³": "çœŸã£ç›´ãä¼¸ã³ã‚‹æ­£ç¾©æ„Ÿ", "ç›¸æ€§": ["å·±", "ç™¸"]},
    "ä¹™": {"ã‚¿ã‚¤ãƒ—": "ğŸŒ· è‰èŠ±", "æ„å‘³": "æŸ”è»Ÿã§ç²˜ã‚Šå¼·ã„å’Œã®ç²¾ç¥", "ç›¸æ€§": ["åºš", "å£¬"]},
    "ä¸™": {"ã‚¿ã‚¤ãƒ—": "â˜€ï¸ å¤ªé™½", "æ„å‘³": "æ˜ã‚‹ãæƒ…ç†±çš„ãªã‚«ãƒªã‚¹ãƒ", "ç›¸æ€§": ["è¾›", "ä¹™"]},
    "ä¸": {"ã‚¿ã‚¤ãƒ—": "ğŸ•¯ï¸ ç¯ç«", "æ„å‘³": "æ´å¯ŸåŠ›ã®é‹­ã„çŸ¥æ€§æ´¾", "ç›¸æ€§": ["å£¬", "ç”²"]},
    "æˆŠ": {"ã‚¿ã‚¤ãƒ—": "â›°ï¸ å±±å²³", "æ„å‘³": "åŒ…å®¹åŠ›ã®ã‚ã‚‹å®‰å®šæ„Ÿ", "ç›¸æ€§": ["ç™¸", "ä¸™"]},
    "å·±": {"ã‚¿ã‚¤ãƒ—": "ğŸ¡ ç”°åœ’", "æ„å‘³": "æ„›æƒ…æ·±ãäººã‚’è‚²ã¦ã‚‹ã®ãŒä¸Šæ‰‹", "ç›¸æ€§": ["ç”²", "ä¸"]},
    "åºš": {"ã‚¿ã‚¤ãƒ—": "âš”ï¸ é‹¼é‰„", "æ„å‘³": "æ„å¿—ãŒå¼·ãæ±ºæ–­åŠ›ãŒã‚ã‚‹", "ç›¸æ€§": ["ä¹™", "æˆŠ"]},
    "è¾›": {"ã‚¿ã‚¤ãƒ—": "ğŸ’ å®çŸ³", "æ„å‘³": "ç¹Šç´°ã§ç¾æ„è­˜ãŒé«˜ã„", "ç›¸æ€§": ["ä¸™", "å·±"]},
    "å£¬": {"ã‚¿ã‚¤ãƒ—": "ğŸŒŠ å¤§æµ·", "æ„å‘³": "è‡ªç”±ã§çŸ¥æ€§çš„ãªãƒ­ãƒãƒ³æ´¾", "ç›¸æ€§": ["ä¸", "åºš"]},
    "ç™¸": {"ã‚¿ã‚¤ãƒ—": "â˜” é›¨éœ²", "æ„å‘³": "å‹¤å‹‰ã§æ…ˆæ„›ã«æº€ã¡ãŸçŸ¥æµè€…", "ç›¸æ€§": ["æˆŠ", "è¾›"]}
}

jukkan = list(jukkan_info.keys())
junishi = ["å­", "ä¸‘", "å¯…", "å¯", "è¾°", "å·³", "åˆ", "æœª", "ç”³", "é…‰", "æˆŒ", "äº¥"]

tenchu_period = {
    "æˆŒäº¥": "æ¯å¹´10æœˆãƒ»11æœˆ", "ç”³é…‰": "æ¯å¹´8æœˆãƒ»9æœˆ", "åˆæœª": "æ¯å¹´6æœˆãƒ»7æœˆ",
    "è¾°å·³": "æ¯å¹´4æœˆãƒ»5æœˆ", "å¯…å¯": "æ¯å¹´2æœˆãƒ»3æœˆ", "å­ä¸‘": "æ¯å¹´12æœˆãƒ»1æœˆ"
}

unsei_trans = {
    "èƒ": "æº–å‚™æœŸ", "é¤Š": "è‚²æˆæœŸ", "é•·ç”Ÿ": "ç™ºå±•æœŸ", "æ²æµ´": "ä¸å®‰å®šæœŸ",
    "å† å¸¯": "å‰é€²æœŸ", "å»ºç¦„": "æœ€ç››æœŸ", "å¸æ—º": "é ‚ç‚¹æœŸ", "è¡°": "å††ç†ŸæœŸ",
    "ç—…": "å†…çœæœŸ", "æ­»": "æ¢æ±‚æœŸ", "å¢“": "è“„ç©æœŸ", "çµ¶": "è»¢æ›æœŸ"
}

def get_kanshi(target_date):
    if target_date is None:  # ã‚¨ãƒ©ãƒ¼å¯¾ç­–ï¼šæ—¥ä»˜ãŒç©ºãªã‚‰è¨ˆç®—ã—ãªã„
        return None, None, None
    diff = (target_date - date(1900, 1, 1)).days
    idx = (diff + 10) % 60
    return jukkan[idx % 10], junishi[idx % 12], idx

def get_tenchusatsu(day_idx):
    group = day_idx // 10
    mapping = ["æˆŒäº¥", "ç”³é…‰", "åˆæœª", "è¾°å·³", "å¯…å¯", "å­ä¸‘"]
    return mapping[group % 6]

st.subheader("ğŸ”® ç²¾å¯†é‘‘å®šã‚«ãƒ«ãƒ†ï¼šã‚¨ãƒ©ãƒ¼å¯¾ç­–ç‰ˆ")

# 1. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å…¥åŠ›
with st.expander("ğŸ‘¤ é‘‘å®šãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆåˆæœŸå€¤ï¼šæœ¬æ—¥ï¼‰", expanded=True):
    today = date.today()
    c1, c2, c3 = st.columns(3)
    y_val = c1.number_input("ç”Ÿã¾ã‚ŒãŸå¹´", 1900, 2100, 1957) # ã‚ãªãŸã®å¹´ã«è¨­å®š
    m_val = c2.number_input("ç”Ÿã¾ã‚ŒãŸæœˆ", 1, 12, 11)      # ã‚ãªãŸã®æœˆã«è¨­å®š
    d_val = c3.number_input("ç”Ÿã¾ã‚ŒãŸæ—¥", 1, 31, 20)      # ã‚ãªãŸã®æ—¥ã«è¨­å®š
    birth_date = date(y_val, m_val, d_val)
    
    use_time = st.checkbox("ç”Ÿã¾ã‚ŒãŸæ™‚é–“ã‚’æŒ‡å®šã™ã‚‹")
    if use_time:
        st.time_input("ç”Ÿã¾ã‚ŒãŸæ™‚é–“", value=time(12, 0))
    
    event_date = st.date_input("ã‚¤ãƒ™ãƒ³ãƒˆçµŒéæ—¥æ•°ï¼ˆä»»æ„ï¼šèµ·ç®—æ—¥ã‚’é¸æŠï¼‰", value=None)

# 2. ç›¸æ€§é‘‘å®š
st.markdown("---")
st.markdown("##### ğŸ¤ ç›¸æ€§é‘‘å®šï¼ˆã”å®¶æ—ãƒ»å‹äººï¼‰")
col_a, col_b = st.columns(2)
partner_name = col_a.text_input("ãŠç›¸æ‰‹ã®ãŠåå‰", placeholder="ä¾‹ï¼šã‹ã¿ã•ã‚“")
partner_date = col_b.date_input("ãŠç›¸æ‰‹ã®ç”Ÿå¹´æœˆæ—¥", value=None) # æœ€åˆã¯ç©ºã«ã™ã‚‹

# 3. é‘‘å®šå®Ÿè¡Œ
if st.button("å››æŸ±æ¨å‘½ã®é‘‘å®šã‚’å®Ÿè¡Œ", use_container_width=True):
    n_kan, n_shi, n_idx = get_kanshi(birth_date)
    tenchu = get_tenchusatsu(n_idx)
    unsei_list = ["é•·ç”Ÿ", "æ²æµ´", "å† å¸¯", "å»ºç¦„", "å¸æ—º", "è¡°", "ç—…", "æ­»", "å¢“", "çµ¶", "èƒ", "é¤Š"]
    unsei = unsei_list[n_idx % 12]

    st.markdown("---")
    st.markdown(f"### ğŸ“œ ã‚ãªãŸã®æœ¬è³ªã¯ã€{jukkan_info[n_kan]['ã‚¿ã‚¤ãƒ—']}ã€‘ã§ã™")
    
    res_df = pd.DataFrame({
        "é …ç›®": ["é­‚ã®å§¿", "æ³¨æ„ã©ãï¼ˆå¤©ä¸­æ®ºï¼‰", "ä»Šã®å‹¢ã„", "æ‰èƒ½ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰"],
        "é‘‘å®šçµæœ": [f"{jukkan_info[n_kan]['ã‚¿ã‚¤ãƒ—']}", f"{tenchu}ç©ºäº¡", f"{unsei_trans[unsei]}", "å°‚é–€æŠ€è¡“ãƒ»æ¢æ±‚ãƒ»è¡¨ç¾"],
        "è©³ã—ã„è§£èª¬": [
            f"{jukkan_info[n_kan]['æ„å‘³']}ã‚’è¡¨ã—ã¾ã™ã€‚",
            f"å…·ä½“çš„ã«ã¯ã€{tenchu_period[tenchu]}ã€‘ã€‚ã“ã®æ™‚æœŸã¯ç„¡ç†ã‚’æ§ãˆã¾ã—ã‚‡ã†ã€‚",
            f"ã€Œ{unsei}ã€ã¨ã„ã†ã‚¨ãƒãƒ«ã‚®ãƒ¼ã€‚ç¾åœ¨ã¯å†…é¢ã‚’å……å®Ÿã•ã›ã‚‹æ™‚ã§ã™ã€‚",
            "Pythonã‚„ãƒ–ãƒ­ã‚°ãªã©ã€ä¸€ã¤ã®ã“ã¨ã‚’æ·±ã‚ã‚‹æ‰èƒ½ãŒã‚ã‚Šã¾ã™ã€‚"
        ]
    })
    st.table(res_df)

    # ç›¸æ€§é‘‘å®šï¼ˆãŠç›¸æ‰‹ã®æ—¥ä»˜ãŒã‚ã‚‹å ´åˆã®ã¿å®Ÿè¡Œï¼‰
    if partner_date:
        p_kan, p_shi, _ = get_kanshi(partner_date)
        p_type = jukkan_info[p_kan]['ã‚¿ã‚¤ãƒ—']
        st.success(f"ğŸ¤ **{partner_name if partner_name else 'ãŠç›¸æ‰‹'}ã•ã‚“ã¨ã®ç›¸æ€§**")
        st.write(f"æ€§è³ªã¯ã€{p_type}ã€‘ã§ã™ã€‚")
        if p_kan in jukkan_info[n_kan]['ç›¸æ€§']:
            st.write("ğŸŒŸ **æœ€é«˜ã®ç›¸æ€§ã§ã™ï¼**")
        else:
            st.write("ğŸµ **è½ã¡ç€ã„ãŸç›¸æ€§ã§ã™ã€‚**")

    if event_date:
        days_passed = (today - event_date).days
        st.info(f"ğŸš© **ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆè¡“å¾Œç­‰ï¼‰ã‹ã‚‰ {days_passed} æ—¥ç›®**") # 2026/1/14ã§273æ—¥ç›®

    # ãƒã‚¤ã‚ªãƒªã‚ºãƒ 
    st.markdown("#### ğŸ“ˆ æœªæ¥ãƒã‚¤ã‚ªãƒªã‚ºãƒ ï¼ˆ2026-2035ï¼‰")
    years = [str(2026 + i) for i in range(10)]
    powers = [((n_idx + i * 7) % 12) + 1 for i in range(10)]
    st.line_chart(pd.DataFrame({"ãƒ‘ãƒ¯ãƒ¼": powers}, index=years))
