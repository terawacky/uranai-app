import streamlit as st
from datetime import datetime, date
import pandas as pd

# ãƒšãƒ¼ã‚¸è¨­å®š
st.set_page_config(page_title="æœ¬æ ¼å››æŸ±æ¨å‘½ãƒ»å®Œå…¨é‘‘å®š", layout="centered")

# --- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆè§£èª¬ã‚’åˆ†ã‹ã‚Šã‚„ã™ãå¼·åŒ–ï¼‰ ---
jukkan = ["ç”²", "ä¹™", "ä¸™", "ä¸", "æˆŠ", "å·±", "åºš", "è¾›", "å£¬", "ç™¸"]
junishi = ["å­", "ä¸‘", "å¯…", "å¯", "è¾°", "å·³", "åˆ", "æœª", "ç”³", "é…‰", "æˆŒ", "äº¥"]

# å¤©ä¸­æ®ºã®å…·ä½“çš„æ™‚æœŸãƒ‡ãƒ¼ã‚¿
tenchu_period = {
    "æˆŒäº¥": "æ¯å¹´ã€Œ10æœˆãƒ»11æœˆã€ãŠã‚ˆã³ã€ŒæˆŒå¹´ãƒ»äº¥å¹´ã€",
    "ç”³é…‰": "æ¯å¹´ã€Œ8æœˆãƒ»9æœˆã€ãŠã‚ˆã³ã€Œç”³å¹´ãƒ»é…‰å¹´ã€",
    "åˆæœª": "æ¯å¹´ã€Œ6æœˆãƒ»7æœˆã€ãŠã‚ˆã³ã€Œåˆå¹´ãƒ»æœªå¹´ã€",
    "è¾°å·³": "æ¯å¹´ã€Œ4æœˆãƒ»5æœˆã€ãŠã‚ˆã³ã€Œè¾°å¹´ãƒ»å·³å¹´ã€",
    "å¯…å¯": "æ¯å¹´ã€Œ2æœˆãƒ»3æœˆã€ãŠã‚ˆã³ã€Œå¯…å¹´ãƒ»å¯å¹´ã€",
    "å­ä¸‘": "æ¯å¹´ã€Œ12æœˆãƒ»1æœˆã€ãŠã‚ˆã³ã€Œå­å¹´ãƒ»ä¸‘å¹´ã€"
}

# åäºŒé‹æ˜Ÿã®ç¿»è¨³
unsei_trans = {
    "èƒ": "æº–å‚™æœŸï¼ˆæ–°ã—ã„èŠ½ãŒå‡ºã‚‹å‰ï¼‰", "é¤Š": "è‚²æˆæœŸï¼ˆã˜ã£ãã‚Šè‚²ã¦ã‚‹æ™‚ï¼‰", 
    "é•·ç”Ÿ": "ç™ºå±•æœŸï¼ˆé †èª¿ã«ä¼¸ã³ã‚‹æ™‚ï¼‰", "æ²æµ´": "ä¸å®‰å®šæœŸï¼ˆè¿·ã„ã‚„ã™ã„ãŒæˆé•·ã‚ã‚Šï¼‰",
    "å† å¸¯": "å‰é€²æœŸï¼ˆç‹¬ç«‹ç‹¬æ­©ã§é€²ã‚€æ™‚ï¼‰", "å»ºç¦„": "æœ€ç››æœŸï¼ˆå®ŸåŠ›ç™ºæ®ã®é»„é‡‘æœŸï¼‰",
    "å¸æ—º": "é ‚ç‚¹æœŸï¼ˆãƒ‘ãƒ¯ãƒ¼æœ€å¤§ã€éä¿¡æ³¨æ„ï¼‰", "è¡°": "å††ç†ŸæœŸï¼ˆçµŒé¨“ã‚’æ´»ã‹ã™æ™‚ï¼‰",
    "ç—…": "å†…çœæœŸï¼ˆå¿ƒã¨ä½“ã®ã‚±ã‚¢ã‚’å„ªå…ˆï¼‰", "æ­»": "æ¢æ±‚æœŸï¼ˆç²¾ç¥æ€§ã‚’é«˜ã‚ã‚‹æ™‚ï¼‰",
    "å¢“": "è“„ç©æœŸï¼ˆçŸ¥è­˜ã‚„è²¡ã‚’æºœã‚ã‚‹æ™‚ï¼‰", "çµ¶": "è»¢æ›æœŸï¼ˆã‚¼ãƒ­ã‹ã‚‰ã®ãƒªã‚»ãƒƒãƒˆï¼‰"
}

def get_kanshi(target_date):
    diff = (target_date - date(1900, 1, 1)).days
    idx = (diff + 10) % 60
    return jukkan[idx % 10], junishi[idx % 12], idx

def get_tenchusatsu(day_idx):
    group = day_idx // 10
    mapping = ["æˆŒäº¥", "ç”³é…‰", "åˆæœª", "è¾°å·³", "å¯…å¯", "å­ä¸‘"]
    return mapping[group % 6]

st.subheader("ğŸ”® çµ±åˆé‘‘å®šã‚«ãƒ«ãƒ†ï¼šã‚„ã•ã—ã„ãƒ—ãƒ­è§£èª¬ç‰ˆ")

# 1. é‘‘å®šãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å…¥åŠ›
with st.expander("ğŸ‘¤ é‘‘å®šãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆç”Ÿå¹´æœˆæ—¥ã®åˆæœŸå€¤ã¯æœ¬æ—¥ï¼‰", expanded=True):
    today = date.today()
    c1, c2, c3 = st.columns(3)
    y_val = c1.number_input("ç”Ÿã¾ã‚ŒãŸå¹´", 1900, 2100, today.year)
    m_val = c2.number_input("ç”Ÿã¾ã‚ŒãŸæœˆ", 1, 12, today.month)
    d_val = c3.number_input("ç”Ÿã¾ã‚ŒãŸæ—¥", 1, 31, today.day)
    birth_date = date(y_val, m_val, d_val)
    event_date = st.date_input("ã‚¤ãƒ™ãƒ³ãƒˆçµŒéæ—¥æ•°ï¼ˆä»»æ„ï¼šèµ·ç®—æ—¥ã‚’é¸æŠï¼‰", value=None, format="YYYY/MM/DD")

# 2. ç›¸æ€§é‘‘å®š
st.markdown("---")
st.markdown("##### ğŸ¤ ç›¸æ€§é‘‘å®šï¼ˆã”å®¶æ—ãƒ»å‹äººï¼‰")
partner_name = st.text_input("ãŠç›¸æ‰‹ã®ãŠåå‰", placeholder="ä¾‹ï¼šã‹ã¿ã•ã‚“")
partner_date = st.date_input("ãŠç›¸æ‰‹ã®ç”Ÿå¹´æœˆæ—¥", value=today)

# 3. é‘‘å®šå®Ÿè¡Œ
if st.button("å››æŸ±æ¨å‘½ã®é‘‘å®šã‚’å®Ÿè¡Œ", use_container_width=True):
    n_kan, n_shi, n_idx = get_kanshi(birth_date)
    tenchu = get_tenchusatsu(n_idx)
    unsei_list = ["é•·ç”Ÿ", "æ²æµ´", "å† å¸¯", "å»ºç¦„", "å¸æ—º", "è¡°", "ç—…", "æ­»", "å¢“", "çµ¶", "èƒ", "é¤Š"]
    unsei = unsei_list[n_idx % 12]

    # --- å®¿å‘½ã®ç²¾å¯†è§£èª­ï¼ˆã“ã“ã‚’åˆ†ã‹ã‚Šã‚„ã™ãã—ã¾ã—ãŸï¼‰ ---
    st.markdown("---")
    st.markdown("### ğŸ“œ ã‚ãªãŸã®ã€Œå–ã‚Šæ‰±ã„èª¬æ˜æ›¸ã€")
    
    res_df = pd.DataFrame({
        "é …ç›®": ["æœ¬è³ªï¼ˆé­‚ã®å½¢ï¼‰", "æ³¨æ„ã©ãï¼ˆå¤©ä¸­æ®ºï¼‰", "ä»Šã®å‹¢ã„ï¼ˆåäºŒé‹æ˜Ÿï¼‰", "æŒã£ã¦ã„ã‚‹æ‰èƒ½"],
        "å…·ä½“çš„ãªå†…å®¹": [
            f"{n_kan}{n_shi}ï¼ˆ{n_kan}ã®æ°—ï¼‰",
            f"{tenchu}ç©ºäº¡",
            f"{unsei}ï¼ˆ{unsei_trans[unsei]}ï¼‰",
            "æŠ€è¡“ãƒ»ãƒ–ãƒ­ã‚°ãƒ»æ¢æ±‚å¿ƒ"
        ],
        "ã„ã¤ï¼Ÿ ã©ã†ã™ã‚Œã°ï¼Ÿ": [
            "ã‚ãªãŸã®æ ¹ã£ã“ã®æ€§æ ¼ã§ã™ã€‚",
            f"å…·ä½“çš„ã«ã¯ã€{tenchu_period[tenchu]}ã€‘ã€‚ã“ã®æ™‚æœŸã¯ç„¡ç†ã›ãšè‡ªåˆ†ã‚’åŠ´ã‚ã£ã¦ã€‚",
            "ç¾åœ¨ã¯ãƒ‘ãƒ¯ãƒ¼ã‚’æºœã‚ã‚‹ã‚ˆã‚Šã‚‚ã€ã˜ã£ãã‚Šæ·±ã‚ã‚‹ã®ã«å‘ã„ãŸã‚¨ãƒãƒ«ã‚®ãƒ¼ã§ã™ã€‚",
            "Pythonã‚„ãƒ–ãƒ­ã‚°é‹å–¶ãªã©ã€ã²ã¨ã¤ã®ã“ã¨ã‚’æ·±æ˜ã‚Šã™ã‚‹ã¨æˆåŠŸã—ã¾ã™ã€‚"
        ]
    })
    st.table(res_df)

    if event_date:
        days_passed = (today - event_date).days
        st.success(f"ğŸš© **ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆè¡“å¾Œç­‰ï¼‰ã‹ã‚‰ {days_passed} æ—¥ç›®**") # 2026/1/12æ™‚ç‚¹ã§æ‰‹è¡“ã‹ã‚‰271æ—¥ç›®

    # æœªæ¥ãƒã‚¤ã‚ªãƒªã‚ºãƒ 
    st.markdown("#### ğŸ“ˆ é‹å‹¢ã®æ³¢ï¼ˆ2026å¹´ã€œï¼‰")
    st.write("ã‚°ãƒ©ãƒ•ãŒé«˜ã„æ™‚æœŸã¯ã€Œæ”»ã‚ã€ã€ä½ã„æ™‚æœŸã¯ã€Œå­¦ã³ã¨ä¼‘æ¯ã€ã«å……ã¦ã‚‹ã¨äººç”ŸãŒã‚¹ãƒ ãƒ¼ã‚ºã§ã™ã€‚")
    years = [str(2026 + i) for i in range(10)]
    powers = [((n_idx + i * 7) % 12) + 1 for i in range(10)]
    st.line_chart(pd.DataFrame({"ãƒ‘ãƒ¯ãƒ¼": powers}, index=years))