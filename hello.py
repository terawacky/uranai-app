import streamlit as st
from datetime import datetime, time, date
import pandas as pd

# ãƒšãƒ¼ã‚¸è¨­å®š
st.set_page_config(page_title="æœ¬æ ¼å››æŸ±æ¨å‘½ãƒ»ç²¾å¯†é‘‘å®š", layout="wide")

# --- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (è§£èª¬ç”¨) ---
jukkan_desc = {
    "ç”²": "å¤§æ¨¹ï¼šçœŸã£ç›´ãã§æ­£ç¾©æ„ŸãŒå¼·ãã€å‘ä¸Šå¿ƒã«æº¢ã‚Œã‚‹ãƒªãƒ¼ãƒ€ãƒ¼ã‚¿ã‚¤ãƒ—",
    "ä¹™": "è‰èŠ±ï¼šæŸ”è»Ÿã§ç²˜ã‚Šå¼·ãã€å‘¨å›²ã¨å”åŠ›ã—ãªãŒã‚‰ç€å®Ÿã«é€²ã‚€ã‚¿ã‚¤ãƒ—",
    "ä¸™": "å¤ªé™½ï¼šæ˜ã‚‹ãæƒ…ç†±çš„ã§ã€å‘¨å›²ã‚’ç…§ã‚‰ã™ã‚«ãƒªã‚¹ãƒçš„ãªå­˜åœ¨",
    "ä¸": "ç¯ç«ï¼šæ´å¯ŸåŠ›ãŒé‹­ãã€å†…é¢ã«é™ã‹ãªæƒ…ç†±ã‚’ç§˜ã‚ã‚‹èŠ¸è¡“å®¶ã‚¿ã‚¤ãƒ—",
    "æˆŠ": "å±±å²³ï¼šåŒ…å®¹åŠ›ãŒã‚ã‚Šã€å‘¨å›²ã‹ã‚‰åšã„ä¿¡é ¼ã‚’å¾—ã‚‹å®‰å®šæ„Ÿã®ã‚ã‚‹ã‚¿ã‚¤ãƒ—",
    "å·±": "ç”°åœ’ï¼šæ„›æƒ…æ·±ãå¤šæ‰ã§ã€äººã‚’è‚²ã¦ãŸã‚Šæ•™ãˆãŸã‚Šã™ã‚‹ã®ãŒå¾—æ„ãªã‚¿ã‚¤ãƒ—",
    "åºš": "é‹¼é‰„ï¼šæ„å¿—ãŒå¼·ãã€åœ§å€’çš„ãªæ±ºæ–­åŠ›ã¨è¡Œå‹•åŠ›ã§é“ã‚’åˆ‡ã‚Šæ‹“ãã‚¿ã‚¤ãƒ—",
    "è¾›": "å®çŸ³ï¼šç¾æ„è­˜ãŒé«˜ãç¹Šç´°ã§ã€è©¦ç·´ã‚’ä¹—ã‚Šè¶Šãˆã‚‹ã»ã©è¼ãã‚’å¢—ã™ã‚¿ã‚¤ãƒ—",
    "å£¬": "å¤§æµ·ï¼šè‡ªç”±ã§çŸ¥æ€§çš„ã€å¤§ããªè¦–ç‚¹ã§ç‰©äº‹ã‚’æ‰ãˆã‚‹ãƒ­ãƒãƒ³ãƒã‚¹ãƒˆ",
    "ç™¸": "é›¨éœ²ï¼šå‹¤å‹‰ã§æ…ˆæ„›ã«æº€ã¡ã€çŸ¥æµã‚’æ´»ã‹ã—ã¦å‘¨å›²ã‚’æ½¤ã™ã‚¿ã‚¤ãƒ—"
}

st.title("ğŸ”® æœ¬æ ¼å››æŸ±æ¨å‘½ï¼šç²¾å¯†å®¿å‘½é‘‘å®šã‚·ã‚¹ãƒ†ãƒ ")

# --- ã‚µã‚¤ãƒ‰ãƒãƒ¼è¨­å®š ---
st.sidebar.header("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å…¥åŠ›")

# 1. èª•ç”Ÿã€Œå¹´ã€ã‚’æ•°å­—ã§å…¥åŠ›ï¼ˆ1957ãªã©ï¼‰
# ã“ã‚Œã‚’å‹•ã‹ã™ã¨ã€ä¸‹ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã€Œå¹´ã€ãŒé€£å‹•ã—ã¦å¤‰ã‚ã‚Šã¾ã™
y_input = st.sidebar.number_input("1. èª•ç”Ÿå¹´ï¼ˆè¥¿æš¦ï¼‰", min_value=1900, max_value=2100, value=1957)

# 2. èª•ç”Ÿã€Œæœˆãƒ»æ—¥ã€ã‚’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§å…¥åŠ›
# ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆï¼šformatã‚’è¨±å¯ã•ã‚Œã¦ã„ã‚‹ 'YYYY/MM/DD' ã«ä¿®æ­£
birth_date = st.sidebar.date_input(
    "2. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§æœˆæ—¥ã‚’ç¢ºèª",
    value=date(y_input, 11, 20),
    min_value=date(1900, 1, 1),
    format="YYYY/MM/DD"
)

# 3. èª•ç”Ÿæ™‚é–“ã®å…¥åŠ›ï¼ˆä»»æ„ï¼‰
st.sidebar.markdown("---")
use_time = st.sidebar.checkbox("èª•ç”Ÿæ™‚é–“ã‚’å…¥åŠ›ã™ã‚‹")
if use_time:
    birth_time = st.sidebar.time_input("æ™‚é–“ã‚’é¸æŠ", value=time(12, 0))
    time_display = birth_time.strftime("%Hæ™‚%Måˆ†")
else:
    time_display = "ä¸æ˜"

# 4. æ‰‹è¡“æ—¥ï¼ˆä»»æ„ï¼‰
surgery_date = st.sidebar.date_input("æ‰‹è¡“çµŒéã‚’ç¢ºèªï¼ˆä»»æ„ï¼‰", value=None, format="YYYY/MM/DD")

if st.sidebar.button("ç²¾å¯†é‘‘å®šã‚’å®Ÿè¡Œ"):
    # å››æŸ±æ¨å‘½ã®åŸºæœ¬ãƒ‡ãƒ¼ã‚¿
    jukkan = ["ç”²", "ä¹™", "ä¸™", "ä¸", "æˆŠ", "å·±", "åºš", "è¾›", "å£¬", "ç™¸"]
    junishi = ["å­", "ä¸‘", "å¯…", "å¯", "è¾°", "å·³", "åˆ", "æœª", "ç”³", "é…‰", "æˆŒ", "äº¥"]
    
    # æ—¥å¹²æ”¯ã®è¨ˆç®—
    base_date = date(1900, 1, 1)
    # y_inputã¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æœˆæ—¥ã‚’çµ„ã¿åˆã‚ã›ã¦æœ€çµ‚çš„ãªç”Ÿå¹´æœˆæ—¥ã‚’ç¢ºå®š
    final_birth_date = date(y_input, birth_date.month, birth_date.day)
    
    diff_days = (final_birth_date - base_date).days
    n_idx = (diff_days + 10) % 60
    n_kan = jukkan[n_idx % 10]
    n_shi = junishi[n_idx % 12]

    # --- çµæœè¡¨ç¤º ---
    st.header(f"âœ¨ é‘‘å®šçµæœï¼š{n_kan}{n_shi}")
    st.markdown(f"**é‘‘å®šå¯¾è±¡ï¼š** {final_birth_date.year}å¹´{final_birth_date.month}æœˆ{final_birth_date.day}æ—¥ç”Ÿã¾ã‚Œ")

    if surgery_date:
        days_passed = (date.today() - surgery_date).days
        st.success(f"ğŸ¥ æ‰‹è¡“æ—¥ï¼ˆ{surgery_date.strftime('%Y/%m/%d')}ï¼‰ã‹ã‚‰ **{days_passed}æ—¥ç›®** ã§ã™ã€‚")

    tab1, tab2 = st.tabs(["ğŸ“Š å®¿å‘½ã®è§£èª¬", "ğŸ“ˆ 10å¹´ãƒã‚¤ã‚ªãƒªã‚ºãƒ "])

    with tab1:
        st.subheader("ğŸ’¡ ã‚ãªãŸã®å®¿å‘½ãƒ»æœ¬è³ª")
        st.info(f"**ã€{n_kan}ã®æ€§è³ªã€‘** {jukkan_desc.get(n_kan, 'è§£èª¬æº–å‚™ä¸­')}")
        
        st.table(pd.DataFrame({
            "é …ç›®": ["æ—¥æŸ± (ã«ã£ã¡ã‚…ã†)", "ä¸­å¿ƒäº”è¡Œ"],
            "çµæœ": [f"{n_kan}{n_shi}", f"{n_kan}ã®æ°—"],
            "è§£èª¬": ["ã‚ãªãŸã®æœ¬è³ªã€‚è‡ªåˆ†è‡ªèº«ã®æ€§æ ¼ã§ã™ã€‚", "é­‚ã®æ ¹æºã¨ãªã‚‹ã‚¨ãƒãƒ«ã‚®ãƒ¼ã€‚"]
        }))

    with tab2:
        st.subheader("2026å¹´ã‹ã‚‰ã®10å¹´é‹å‹¢ã‚°ãƒ©ãƒ•")
        years = [str(2026 + i) for i in range(11)]
        powers = [((n_idx + i * 7) % 12) + 1 for i in range(11)]
        chart_df = pd.DataFrame({"å¹´": years, "ãƒ‘ãƒ¯ãƒ¼": powers}).set_index("å¹´")
        st.line_chart(chart_df)