import streamlit as st
from datetime import datetime, date
import pandas as pd

# ãƒšãƒ¼ã‚¸è¨­å®š
st.set_page_config(page_title="æœ¬æ ¼å››æŸ±æ¨å‘½ãƒ»çµ±åˆé‘‘å®šã‚·ã‚¹ãƒ†ãƒ ", layout="centered")

# --- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ ---
jukkan = ["ç”²", "ä¹™", "ä¸™", "ä¸", "æˆŠ", "å·±", "åºš", "è¾›", "å£¬", "ç™¸"]
junishi = ["å­", "ä¸‘", "å¯…", "å¯", "è¾°", "å·³", "åˆ", "æœª", "ç”³", "é…‰", "æˆŒ", "äº¥"]

jukkan_info = {
    "ç”²": {"ã‚¿ã‚¤ãƒ—": "å¤§æ¨¹", "æ€§æ ¼": "æ­£ç¾©æ„ŸãŒå¼·ã„ãƒªãƒ¼ãƒ€ãƒ¼", "é‹å‹¢": "æˆé•·ã¨æ‹¡å¤§ã€‚æ–°ã—ã„ä¸€æ­©ãŒå‰ã€‚", "ç›¸æ€§": ["å·±", "ç™¸"]},
    "ä¹™": {"ã‚¿ã‚¤ãƒ—": "è‰èŠ±", "æ€§æ ¼": "æŸ”è»Ÿã§ç²˜ã‚Šå¼·ã„å’Œã®ç²¾ç¥", "é‹å‹¢": "å”èª¿ã¨èª¿å’Œã€‚äººã¨ã®ç¹‹ãŒã‚ŠãŒéµã€‚", "ç›¸æ€§": ["åºš", "å£¬"]},
    "ä¸™": {"ã‚¿ã‚¤ãƒ—": "å¤ªé™½", "æ€§æ ¼": "æ˜ã‚‹ãæƒ…ç†±çš„ãªã‚«ãƒªã‚¹ãƒ", "é‹å‹¢": "æƒ…ç†±ã¨ç™ºä¿¡ã€‚æ³¨ç›®ã‚’é›†ã‚ã‚‹å¥½æ©Ÿã€‚", "ç›¸æ€§": ["è¾›", "ä¹™"]},
    "ä¸": {"ã‚¿ã‚¤ãƒ—": "ç¯ç«", "æ€§æ ¼": "æ´å¯ŸåŠ›ã®é‹­ã„çŸ¥æ€§æ´¾", "é‹å‹¢": "é›†ä¸­ã¨æ¢æ±‚ã€‚å†…é¢ã®å……å®Ÿã«æœ€é©ã€‚", "ç›¸æ€§": ["å£¬", "ç”²"]},
    "æˆŠ": {"ã‚¿ã‚¤ãƒ—": "å±±å²³", "æ€§æ ¼": "åŒ…å®¹åŠ›ã®ã‚ã‚‹å®‰å®šæ„Ÿ", "é‹å‹¢": "å®‰å®šã¨ä¿¡é ¼ã€‚è¶³å ´ã‚’å›ºã‚ã‚‹æ™‚æœŸã€‚", "ç›¸æ€§": ["ç™¸", "ä¸™"]},
    "å·±": {"ã‚¿ã‚¤ãƒ—": "ç”°åœ’", "æ€§æ ¼": "æ„›æƒ…æ·±ãäººã‚’è‚²ã¦ã‚‹ã®ãŒä¸Šæ‰‹", "é‹å‹¢": "è‚²æˆã¨å¥‰ä»•ã€‚äººã‚’åŠ©ã‘ã‚‹ã“ã¨ãŒå¯Œã«ã€‚", "ç›¸æ€§": ["ç”²", "ä¸"]},
    "åºš": {"ã‚¿ã‚¤ãƒ—": "é‹¼é‰„", "æ€§æ ¼": "æ„å¿—ãŒå¼·ãæ±ºæ–­åŠ›ãŒã‚ã‚‹", "é‹å‹¢": "æ±ºæ–­ã¨è¡Œå‹•ã€‚æã‚Œãšå¤‰é©ã‚’ã€‚", "ç›¸æ€§": ["ä¹™", "æˆŠ"]},
    "è¾›": {"ã‚¿ã‚¤ãƒ—": "å®çŸ³", "æ€§æ ¼": "ç¹Šç´°ã§ç¾æ„è­˜ãŒé«˜ã„", "é‹å‹¢": "æ´—ç·´ã¨è©¦ç·´ã€‚ç£¨ãã‚’ã‹ã‘ã‚‹æ™‚ã€‚", "ç›¸æ€§": ["ä¸™", "å·±"]},
    "å£¬": {"ã‚¿ã‚¤ãƒ—": "å¤§æµ·", "æ€§æ ¼": "è‡ªç”±ã§çŸ¥æ€§çš„ãªãƒ­ãƒãƒ³æ´¾", "é‹å‹¢": "è‡ªç”±ã¨çŸ¥æ€§ã€‚åºƒã„è¦–é‡ã§å‹•ãã€‚", "ç›¸æ€§": ["ä¸", "åºš"]},
    "ç™¸": {"ã‚¿ã‚¤ãƒ—": "é›¨éœ²", "æ€§æ ¼": "å‹¤å‹‰ã§æ…ˆæ„›ã«æº€ã¡ãŸçŸ¥æµè€…", "é‹å‹¢": "ç™’ã‚„ã—ã¨çŸ¥æµã€‚å‘¨å›²ã‚’æ½¤ã™å½¹ç›®ã€‚", "ç›¸æ€§": ["æˆŠ", "è¾›"]}
}

def get_kanshi(target_date):
    diff = (target_date - date(1900, 1, 1)).days
    idx = (diff + 10) % 60
    return jukkan[idx % 10], junishi[idx % 12], idx

def get_tenchusatsu(day_idx):
    group = day_idx // 10
    mapping = ["æˆŒäº¥", "ç”³é…‰", "åˆæœª", "è¾°å·³", "å¯…å¯", "å­ä¸‘"]
    return mapping[group % 6]

st.subheader("ğŸ”® çµ±åˆé‘‘å®šã‚«ãƒ«ãƒ†ï¼šãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ç‰ˆ")

# 1. é‘‘å®šãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å…¥åŠ›
with st.expander("ğŸ‘¤ é‘‘å®šãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆç”Ÿå¹´æœˆæ—¥ã®åˆæœŸå€¤ã¯æœ¬æ—¥ã§ã™ï¼‰", expanded=True):
    today = date.today()
    c1, c2, c3 = st.columns(3)
    y_val = c1.number_input("ç”Ÿã¾ã‚ŒãŸå¹´", 1900, 2100, today.year)
    m_val = c2.number_input("ç”Ÿã¾ã‚ŒãŸæœˆ", 1, 12, today.month)
    d_val = c3.number_input("ç”Ÿã¾ã‚ŒãŸæ—¥", 1, 31, today.day)
    birth_date = date(y_val, m_val, d_val)
    
    # æ‰‹è¡“æ—¥ã‚’ã€Œã‚¤ãƒ™ãƒ³ãƒˆæ—¥ã€ã«å¤‰æ›´ã—ã€åˆæœŸå€¤ã‚’ç©ºã«è¨­å®š
    event_date = st.date_input("ã‚¤ãƒ™ãƒ³ãƒˆçµŒéæ—¥æ•°ï¼ˆä»»æ„ï¼šèµ·ç®—æ—¥ã‚’é¸æŠï¼‰", value=None, format="YYYY/MM/DD")

# 2. ç›¸æ€§é‘‘å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³
st.markdown("---")
st.markdown("##### ğŸ¤ ç›¸æ€§é‘‘å®šï¼ˆã”å®¶æ—ãƒ»å‹äººï¼‰")
col_a, col_b = st.columns(2)
partner_name = col_a.text_input("ãŠç›¸æ‰‹ã®ãŠåå‰", placeholder="ä¾‹ï¼šã‹ã¿ã•ã‚“")
partner_date = col_b.date_input("ãŠç›¸æ‰‹ã®ç”Ÿå¹´æœˆæ—¥", value=today)

# 3. å››æŸ±æ¨å‘½ã®é‘‘å®šã‚’å®Ÿè¡Œ
if st.button("å››æŸ±æ¨å‘½ã®é‘‘å®šã‚’å®Ÿè¡Œ", use_container_width=True):
    n_kan, n_shi, n_idx = get_kanshi(birth_date)
    today_kan, today_shi, _ = get_kanshi(today)
    tenchu = get_tenchusatsu(n_idx)
    
    # ä»Šæ—¥ã®æ—¥é‹
    st.info(f"ğŸ“… **ä»Šæ—¥ã®é‹å‹¢ï¼ˆ{today.strftime('%Y/%m/%d')}ï¼‰**\n\nã‚ãªãŸã®æœ¬è³ªï¼š{n_kan} ï¼ ä»Šæ—¥ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼š{today_kan}\n\n**ã€ä»Šæ—¥ã®ä¸€è¨€ã€‘** {jukkan_info[n_kan]['é‹å‹¢']}")

    # ç›¸æ€§é‘‘å®šã®å®Ÿè¡Œ
    if partner_name:
        p_kan, p_shi, _ = get_kanshi(partner_date)
        st.success(f"ğŸ¤ **{partner_name}ã•ã‚“ã¨ã®ç›¸æ€§**\n\n{partner_name}ã•ã‚“ã¯ã€Œ{p_kan}ã€ã®æ€§è³ªã‚’ãŠæŒã¡ã§ã™ã€‚")
        if p_kan in jukkan_info[n_kan]['ç›¸æ€§']:
            st.write("ğŸŒŸ **æœ€é«˜ã®ç›¸æ€§ã§ã™ï¼** ãŠäº’ã„ã‚’è£œã„åˆã„ã€é«˜ã‚åˆãˆã‚‹ç†æƒ³çš„ãªé–¢ä¿‚ã§ã™ã€‚")
        else:
            st.write("ğŸµ **å®‰å®šã—ãŸé–¢ä¿‚ã§ã™ã€‚** é•ã„ã‚’èªã‚åˆã†ã“ã¨ã§ã€ã‚ˆã‚Šæ·±ã„çµ†ãŒç”Ÿã¾ã‚Œã¾ã™ã€‚")

    # ç²¾å¯†è§£èª­
    st.markdown("---")
    st.markdown("#### ğŸ“œ å®¿å‘½ã®ç²¾å¯†è§£èª­")
    unsei_list = ["é•·ç”Ÿ", "æ²æµ´", "å† å¸¯", "å»ºç¦„", "å¸æ—º", "è¡°", "ç—…", "æ­»", "å¢“", "çµ¶", "èƒ", "é¤Š"]
    unsei = unsei_list[n_idx % 12]

    res_df = pd.DataFrame({
        "é‘‘å®šé …ç›®": ["æ—¥æŸ±ï¼ˆè‡ªåˆ†è‡ªèº«ï¼‰", "å¤©ä¸­æ®ºï¼ˆä¼‘æ¯æœŸï¼‰", "åäºŒé‹æ˜Ÿï¼ˆå‹¢ã„ï¼‰", "æœ¬è³ªçš„ãªæ‰èƒ½"],
        "çµæœ": [f"{n_kan}{n_shi}", f"{tenchu}ç©ºäº¡", unsei, "é£Ÿç¥ãƒ»åå°ï¼ˆæŠ€è¡“ã¨æ¢æ±‚ï¼‰"],
        "ãƒ—ãƒ­ã®è¦–ç‚¹": [
            "ã‚ãªãŸã®æ ¸ã¨ãªã‚‹æ˜Ÿã§ã™ã€‚",
            f"{tenchu}ã®æ™‚æœŸã¯ç„¡ç†ã‚’ã›ãšã€ä½“èª¿ç®¡ç†ã‚„å­¦ã³ã‚’å„ªå…ˆã™ã¹ãæ™‚ã§ã™ã€‚",
            f"ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¯ã€Œ{unsei}ã€ã€‚ç¾åœ¨ã®ç²¾ç¥çŠ¶æ…‹ã‚’è¡¨ã—ã¾ã™ã€‚",
            "å°‚é–€æŠ€è¡“ã‚’æ·±ã‚ã€ãƒ–ãƒ­ã‚°ã‚„Pythonãªã©ã§è¡¨ç¾ã™ã‚‹æ‰èƒ½ãŒã‚ã‚Šã¾ã™ã€‚"
        ]
    })
    st.table(res_df)

    # çµŒéæ—¥æ•°ã®è¡¨ç¤ºï¼ˆå…¥åŠ›ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
    if event_date:
        days_passed = (today - event_date).days
        st.success(f"ğŸš© **ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ {days_passed} æ—¥ç›®**")

    # æœªæ¥ãƒã‚¤ã‚ªãƒªã‚ºãƒ 
    st.markdown("#### ğŸ“ˆ æœªæ¥ãƒã‚¤ã‚ªãƒªã‚ºãƒ ï¼ˆ2026-2035ï¼‰")
    years = [str(2026 + i) for i in range(10)]
    powers = [((n_idx + i * 7) % 12) + 1 for i in range(10)]
    st.line_chart(pd.DataFrame({"ãƒ‘ãƒ¯ãƒ¼": powers}, index=years))