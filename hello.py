import streamlit as st
from datetime import datetime, time, date
import pandas as pd

# ãƒšãƒ¼ã‚¸è¨­å®šï¼ˆã‚¹ãƒãƒ›æœ€é©åŒ–ï¼‰
st.set_page_config(page_title="æœ¬æ ¼å››æŸ±æ¨å‘½ãƒ»ç²¾å¯†é‘‘å®š", layout="centered")

# --- è§£èª¬ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ ---
jukkan_desc = {
    "ç”²": "ã€Œå¤§æ¨¹ã€ï¼šçœŸã£ç›´ãã§æ­£ç¾©æ„ŸãŒå¼·ã„ãƒªãƒ¼ãƒ€ãƒ¼ã‚¿ã‚¤ãƒ—",
    "ä¹™": "ã€Œè‰èŠ±ã€ï¼šæŸ”è»Ÿã§ç²˜ã‚Šå¼·ãã€å’Œã‚’é‡ã‚“ã˜ã‚‹ã‚¿ã‚¤ãƒ—",
    "ä¸™": "ã€Œå¤ªé™½ã€ï¼šæ˜ã‚‹ãæƒ…ç†±çš„ã€‚å‘¨å›²ã‚’ç…§ã‚‰ã™ã‚«ãƒªã‚¹ãƒçš„ãªå­˜åœ¨",
    "ä¸": "ã€Œç¯ç«ã€ï¼šå†…é¢ã«æƒ…ç†±ã‚’ç§˜ã‚ã‚‹ã€æ´å¯ŸåŠ›ã®é‹­ã„èŠ¸è¡“å®¶ã‚¿ã‚¤ãƒ—",
    "æˆŠ": "ã€Œå±±å²³ã€ï¼šåŒ…å®¹åŠ›ãŒã‚ã‚Šã€å‘¨å›²ã‹ã‚‰ä¿¡é ¼ã•ã‚Œã‚‹å®‰å®šæ„Ÿã®ã‚ã‚‹ã‚¿ã‚¤ãƒ—",
    "å·±": "ã€Œç”°åœ’ã€ï¼šæ„›æƒ…æ·±ãå¤šæ‰ã§ã€äººã‚’è‚²ã¦ã‚‹ã®ãŒå¾—æ„ãªã‚¿ã‚¤ãƒ—",
    "åºš": "ã€Œé‹¼é‰„ã€ï¼šæ„å¿—ãŒå¼·ãã€æ±ºæ–­åŠ›ã¨è¡Œå‹•åŠ›ã§é“ã‚’åˆ‡ã‚Šæ‹“ãã‚¿ã‚¤ãƒ—",
    "è¾›": "ã€Œå®çŸ³ã€ï¼šç¹Šç´°ã§ç¾æ„è­˜ãŒé«˜ãã€è©¦ç·´ã‚’è¶Šãˆã¦è¼ãæ€§è³ª",
    "å£¬": "ã€Œå¤§æµ·ã€ï¼šè‡ªç”±ã§çŸ¥æ€§çš„ã€å¤§ããªè¦–ç‚¹ã§ç‰©äº‹ã‚’æ‰ãˆã‚‹ãƒ­ãƒãƒ³ãƒã‚¹ãƒˆ",
    "ç™¸": "ã€Œé›¨éœ²ã€ï¼šå‹¤å‹‰ã§æ…ˆæ„›ã«æº€ã¡ã€çŸ¥æµã§å‘¨å›²ã‚’æ½¤ã™ã‚¿ã‚¤ãƒ—"
}

st.title("ğŸ”® æœ¬æ ¼å››æŸ±æ¨å‘½ï¼šäººç”Ÿã®é‘‘å®šæ›¸")

st.markdown("### ğŸ“… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å…¥åŠ›")
st.write("ã‚¹ãƒãƒ›ã®æ–¹ã¯ã€ä¸‹ã®æ•°å­—ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚")

# --- å…¥åŠ›æ¬„ã‚’ç¸¦ã«ä¸¦ã¹ã¦ç¢ºå®Ÿã«è¡¨ç¤º ---
# 1. å¹´
y_val = st.number_input("â‘  èª•ç”Ÿå¹´ (è¥¿æš¦)", min_value=1900, max_value=2100, value=1957)

# 2. æœˆï¼ˆæ•°å­—ã§é¸ã¶ã®ã§ã‚¹ãƒãƒ›ã§ã‚‚ç¢ºå®Ÿï¼‰
m_val = st.number_input("â‘¡ èª•ç”Ÿæœˆ", min_value=1, max_value=12, value=11)

# 3. æ—¥ï¼ˆæ•°å­—ã§é¸ã¶ã®ã§ã‚¹ãƒãƒ›ã§ã‚‚ç¢ºå®Ÿï¼‰
d_val = st.number_input("â‘¢ èª•ç”Ÿæ—¥", min_value=1, max_value=31, value=20)

# ç”Ÿå¹´æœˆæ—¥ã®ç¢ºå®š
try:
    birth_date = date(y_val, m_val, d_val)
except:
    st.error("æ­£ã—ã„æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
    st.stop()

st.markdown("---")

# èª•ç”Ÿæ™‚é–“ï¼ˆä»»æ„ï¼‰
use_time = st.checkbox("èª•ç”Ÿæ™‚é–“ã‚’æŒ‡å®šã™ã‚‹")
if use_time:
    birth_time = st.time_input("æ™‚é–“", value=time(12, 0))
    time_str = birth_time.strftime("%Hæ™‚%Måˆ†")
else:
    time_str = "ä¸æ˜"

# æ‰‹è¡“æ—¥ï¼ˆä»»æ„ï¼‰
surgery_date = st.date_input("æ‰‹è¡“çµŒéã‚’ç¢ºèª (ä»»æ„)", value=None, format="YYYY/MM/DD")

# é‘‘å®šãƒœã‚¿ãƒ³
if st.button("é‘‘å®šã‚’å®Ÿè¡Œã™ã‚‹", use_container_width=True):
    today = date.today()
    jukkan = ["ç”²", "ä¹™", "ä¸™", "ä¸", "æˆŠ", "å·±", "åºš", "è¾›", "å£¬", "ç™¸"]
    junishi = ["å­", "ä¸‘", "å¯…", "å¯", "è¾°", "å·³", "åˆ", "æœª", "ç”³", "é…‰", "æˆŒ", "äº¥"]
    
    base_date = date(1900, 1, 1)
    diff_days = (birth_date - base_date).days
    n_idx = (diff_days + 10) % 60
    n_kan = jukkan[n_idx % 10]
    n_shi = junishi[n_idx % 12]

    st.markdown("---")
    st.header(f"âœ¨ é‘‘å®šçµæœï¼š{n_kan}{n_shi}")
    st.write(f"é‘‘å®šå¯¾è±¡ï¼š{birth_date.year}å¹´{birth_date.month}æœˆ{birth_date.day}æ—¥")
    
    if surgery_date:
        days_passed = (today - surgery_date).days
        st.success(f"ğŸ¥ æ‰‹è¡“æ—¥ã‹ã‚‰ **{days_passed}æ—¥ç›®** ã§ã™ã€‚")

    tab1, tab2 = st.tabs(["ğŸ“Š è§£èª¬", "ğŸ“ˆ é‹å‹¢"])

    with tab1:
        st.subheader("ğŸ’¡ é‘‘å®šç”¨èªã®è§£èª¬")
        # æ„å‘³ã‚’å¼·åŒ–ã—ãŸè¡¨
        explanation_df = pd.DataFrame({
            "é …ç›®": ["æ—¥æŸ± (è‡ªåˆ†è‡ªèº«)", "é­‚ã®æ€§è³ª", "æ€§æ ¼ã®ã‚¿ã‚¤ãƒ—"],
            "çµæœ": [f"{n_kan}{n_shi}", f"{n_kan}ã®æ°—", n_kan],
            "ãƒ—ãƒ­ã®è§£èª¬": [
                "ã‚ãªãŸã®æœ¬è³ªã€‚æœ€ã‚‚é‡è¦ãªæ˜Ÿã§ã™ã€‚",
                "ç”Ÿã¾ã‚ŒæŒã£ãŸè‡ªç„¶ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã€‚",
                jukkan_desc.get(n_kan, "")
            ]
        })
        st.table(explanation_df)

    with tab2:
        st.subheader("2026å¹´ã‹ã‚‰ã®ãƒã‚¤ã‚ªãƒªã‚ºãƒ ")
        years = [str(2026 + i) for i in range(11)]
        powers = [((n_idx + i * 7) % 12) + 1 for i in range(11)]
        st.line_chart(pd.DataFrame({"å¹´": years, "ãƒ‘ãƒ¯ãƒ¼": powers}).set_index("å¹´"))