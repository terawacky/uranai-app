import streamlit as st
from datetime import datetime, time, date
import pandas as pd

# ãƒšãƒ¼ã‚¸è¨­å®š
st.set_page_config(page_title="æœ¬æ ¼å››æŸ±æ¨å‘½ãƒ»ç²¾å¯†é‘‘å®š", layout="wide")

# --- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ ---
jukkan = ["ç”²", "ä¹™", "ä¸™", "ä¸", "æˆŠ", "å·±", "åºš", "è¾›", "å£¬", "ç™¸"]
junishi = ["å­", "ä¸‘", "å¯…", "å¯", "è¾°", "å·³", "åˆ", "æœª", "ç”³", "é…‰", "æˆŒ", "äº¥"]

# ç”¨èªè§£èª¬ã®è¾æ›¸
desc_dict = {
    "æ—¥æŸ±": "ã€Œè‡ªåˆ†è‡ªèº«ã€ã‚’è¡¨ã™æœ€ã‚‚é‡è¦ãªå ´æ‰€ã§ã™ã€‚ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚„æœ¬è³ªã‚’ç¤ºã—ã¾ã™ã€‚",
    "ä¸­å¿ƒäº”è¡Œ": "ã‚ãªãŸã®é­‚ã®ã€Œç‡ƒæ–™ã€ã¨ãªã‚‹ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®ç¨®é¡ã§ã™ã€‚",
    "ä¸™": "ã€Œå¤ªé™½ã€ã®è±¡å¾´ã€‚æ˜ã‚‹ãã€å‘¨å›²ã‚’ç…§ã‚‰ã—ã€ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã‚’ç™ºæ®ã™ã‚‹æ€§è³ªã§ã™ã€‚"
}

st.title("ğŸ”® æœ¬æ ¼å››æŸ±æ¨å‘½ï¼šã‚ãªãŸã®å®¿å‘½ã‚’èª­ã¿è§£ã")

# --- ã‚µã‚¤ãƒ‰ãƒãƒ¼å…¥åŠ› ---
st.sidebar.header("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å…¥åŠ›")
today_val = date.today()
y = st.sidebar.number_input("å¹´", min_value=1900, max_value=2100, value=today_val.year)
m = st.sidebar.number_input("æœˆ", min_value=1, max_value=12, value=today_val.month)
d = st.sidebar.number_input("æ—¥", min_value=1, max_value=31, value=today_val.day)

birth_date = st.sidebar.date_input("ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§ç¢ºèª", value=date(y, m, d), format="YYYY/MM/DD")
surgery_date = st.sidebar.date_input("æ‰‹è¡“çµŒéï¼ˆä»»æ„ï¼‰", value=None, format="YYYY/MM/DD")

if st.sidebar.button("ç²¾å¯†é‘‘å®šã‚’å®Ÿè¡Œ"):
    # è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
    base_date = date(1900, 1, 1)
    diff_days = (birth_date - base_date).days
    n_idx = (diff_days + 10) % 60
    n_kan = jukkan[n_idx % 10]
    n_shi = junishi[n_idx % 12]

    # è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³
    st.header(f"âœ¨ é‘‘å®šçµæœï¼š{n_kan}{n_shi}ï¼ˆ{n_kan}ã®æ€§è³ªï¼‰")
    
    if surgery_date:
        days_passed = (date.today() - surgery_date).days
        st.success(f"ğŸ¥ æ‰‹è¡“ï¼ˆ2025å¹´4æœˆ16æ—¥ï¼‰ã‹ã‚‰ **{days_passed}æ—¥ç›®**ã€‚é †èª¿ãªå›å¾©ã¨ç™ºå±•ã®é‹æ°—ã§ã™ã€‚")

    t1, t2 = st.tabs(["ğŸ“Š å®¿å‘½ã®è§£èª¬", "ğŸ“ˆ é‹å‹¢ãƒã‚¤ã‚ªãƒªã‚ºãƒ "])

    with t1:
        st.subheader("ğŸ’¡ é‘‘å®šç”¨èªã®è§£èª¬")
        # æ„å‘³ã‚’ä»˜ã‘åŠ ãˆãŸè¡¨ã‚’ä½œæˆ
        kantei_df = pd.DataFrame({
            "ç”¨èª": ["æ—¥æŸ± (ã«ã£ã¡ã‚…ã†)", "ä¸­å¿ƒäº”è¡Œ (ã”ãã‚‡ã†)", "ã‚ãªãŸã®æœ¬è³ª"],
            "é‘‘å®šçµæœ": [f"{n_kan}{n_shi}", f"{n_kan}ã®æ°—", n_kan],
            "æ„å‘³": [
                "ã‚ãªãŸã®ã€Œæœ¬è³ªã€ã‚„ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªå§¿ã€‚äººç”Ÿã®åŸºç›¤ã§ã™ã€‚",
                "ã‚ãªãŸã®æ€§æ ¼ã®æ ¹æºã¨ãªã‚‹è‡ªç„¶ç•Œã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã€‚",
                f"è‡ªç„¶ç•Œã§ã¯ã€Œ{desc_dict.get(n_kan, '')}ã€ã‚’è±¡å¾´ã—ã¾ã™ã€‚"
            ]
        })
        st.table(kantei_df)
        
        # ã•ã‚‰ã«å™›ã¿ç •ã„ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        st.markdown(f"""
        ---
        ### ğŸ§ ãƒ—ãƒ­ã®è¦–ç‚¹ï¼šã‚ãªãŸã®æ˜Ÿã®èª­ã¿è§£ã
        ã‚ãªãŸã®å®¿å‘½æ˜Ÿã§ã‚ã‚‹**ã€Œ{n_kan}{n_shi}ã€**ã¯ã€éå¸¸ã«æ´»å‹•çš„ã§é ­ã®å›è»¢ãŒé€Ÿã„ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚
        ç‰¹ã«ã€Œ{n_kan}ã€ã¯è‡ªç„¶ç•Œã§ã„ã†ã€Œå¤ªé™½ã€ã‚„ã€Œé‹¼ã€ãªã©ã€å¼·ã„å­˜åœ¨æ„Ÿã‚’æ”¾ã¤ã‚¨ãƒãƒ«ã‚®ãƒ¼ã§ã™ã€‚
        
        ä»•äº‹é¢ï¼ˆå›½é‰„ã‚„ãƒã‚¹ã®é‹è»¢ãªã©ï¼‰ã§é•·å¹´è²¬ä»»ã‚’æœãŸã—ã¦ã“ã‚‰ã‚ŒãŸã®ã‚‚ã€ã“ã®å¼·ã„å®¿å‘½ã®æ˜ŸãŒæ”¯ãˆã«ãªã£ã¦ã„ãŸã¨è¨€ãˆã¾ã™ã€‚
        """)

    with t2:
        st.subheader("2026å¹´ã‹ã‚‰ã®10å¹´é‹å‹¢ã‚°ãƒ©ãƒ•")
        years = [str(2026 + i) for i in range(11)]
        powers = [((n_idx + i * 7) % 12) + 1 for i in range(11)]
        st.line_chart(pd.DataFrame({"å¹´": years, "ãƒ‘ãƒ¯ãƒ¼": powers}).set_index("å¹´"))